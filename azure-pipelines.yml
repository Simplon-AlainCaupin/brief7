# Starter pipeline

# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- main

strategy:
  matrix:
    linux:
      imageName: "ubuntu-latest"
#    mac:
#      imageName: "macOS-latest"
#    windows:
#      imageName: "windows-latest"
  maxParallel: 3

pool:
  vmImage: $(imageName)

steps:
- task: Kubernetes@1
  inputs:
    connectionType: 'Kubernetes Service Connection'
    KubernetesServiceEndpoint: 'serviceconnectionakslain'
#     namespace: 'default'
    command: 'top'
    arguments: 'pod'

- task: Cache@2
  inputs:
    key: 'toto'
    path: '/home/vsts/ver'
    cacheHitVar: 'testcache'

# la partie ci dessous récupère le numéro de version dans la variable d'env "TESTVAR"
# déroulé du job : OK - trouver une solution pour stocker le résultat de la variable -> avec "cache"
- task: Bash@3
  inputs:
    targetType: 'inline'
    script: |   
      mkdir /home/vsts/ver
      TESTVAR=$(curl 'https://hub.docker.com/v2/repositories/simplonasa/azure_voting_app/tags' | jq '."results"[0]["name"]')
      echo "bli bla blou !"
      echo "$TESTVAR" > /home/vsts/ver/version
      echo "------------- blblblbl ------------"
      echo "RESULTAT :"
      cat /home/vsts/ver/version

- task: Cache@2
  inputs:
    key: 'toto'
    path: '/home/vsts/ver'
    cacheHitVar: 'testcache'

- task: DownloadGitHubRelease@0
  inputs:
    connection: 'github.com_Simplon-AlainCaupin'
    userRepository: 'Simplon-AlainCaupin/brief7'
    defaultVersionType: 'latest'
    itemPattern: '*app*'
    downloadPath: /home/vsts/gitrelease